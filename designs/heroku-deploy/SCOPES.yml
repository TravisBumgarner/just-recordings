project: Heroku Production Deployment
repo: travisbumgarner/just-recordings
design_file: null  # User requirements provided directly
scoping_date: 2026-01-23

milestones:
  - number: 1
    title: "1. Cloudinary Integration & Schema"
    description: Add Cloudinary SDK and update database schema for Cloudinary storage
    branch:
      working: 145-cloudinary-integration
      base: main

  - number: 2
    title: "2. Direct Cloudinary Upload Flow"
    description: Implement direct browser-to-Cloudinary uploads with signed URLs and client-side chunking
    branch:
      working: 156-direct-cloudinary-upload
      base: main

  - number: 3
    title: "3. Frontend Serving & Heroku Deployment"
    description: Configure API to serve frontend bundle, create Heroku configuration, document deployment
    branch:
      working: 151-heroku-deployment
      base: main

tasks:
  # Milestone 1: Cloudinary Integration & Schema
  - id: 1
    github_issue: 145
    milestone: 1
    title: Add Cloudinary SDK and configuration
    description: |
      Add the Cloudinary Node.js SDK to the API package and create a configuration
      module that validates required environment variables using Zod.

      - Add `cloudinary` npm package to api dependencies
      - Update config.ts with CLOUDINARY_CLOUD_NAME, CLOUDINARY_API_KEY, CLOUDINARY_API_SECRET
      - Add getCloudinary() helper function
      - Update `.env.example` files
    acceptance_criteria:
      - Cloudinary SDK installed and configured
      - Environment variables validated with Zod (fail fast on missing config)
      - Cloudinary client exported and ready for use
      - .env.example updated with Cloudinary variables
    depends_on: []
    effort: 1
    status: completed

  - id: 3
    github_issue: 147
    milestone: 1
    title: Update database schema for Cloudinary storage
    description: |
      Update the recordings table schema to store Cloudinary URLs and public IDs.

      Schema changes:
      - path → video_url (Cloudinary URL)
      - thumbnail_path → thumbnail_url (Cloudinary URL, nullable)
      - Add video_public_id (varchar, for Cloudinary deletion)
      - Add thumbnail_public_id (varchar, nullable)

      Run drizzle-kit generate for migration.
    acceptance_criteria:
      - Schema updated with new column names and types
      - Migration file generated via drizzle-kit
      - Recording TypeScript types updated in shared package
      - Query functions updated to use new column names
    depends_on: []
    effort: 2
    status: completed

  # Milestone 2: Direct Cloudinary Upload Flow
  - id: 4
    github_issue: 156
    milestone: 2
    title: Create Cloudinary signature endpoint
    description: |
      Create an API endpoint that generates Cloudinary upload signatures for
      direct browser uploads.

      **Endpoint:** POST /api/upload/signature

      The endpoint should:
      - Generate a timestamp and signature using Cloudinary API secret
      - Include standard parameters (tags, folder, resource_type)
      - Return all parameters needed for client-side upload

      Response includes: signature, timestamp, cloudName, apiKey, folder, tags, resourceType
    acceptance_criteria:
      - POST /api/upload/signature endpoint created
      - Requires authentication
      - Generates valid Cloudinary signature using API secret
      - Includes environment tags (env:development or env:production)
    depends_on: [1]
    effort: 2
    status: completed

  - id: 5
    github_issue: 157
    milestone: 2
    title: Create recording registration endpoint
    description: |
      Create an API endpoint to register a completed Cloudinary upload in the database.

      **Endpoint:** POST /api/recordings

      After the client uploads directly to Cloudinary, it notifies the API to save
      the recording metadata. This endpoint receives the Cloudinary response and
      creates the database record.

      Request: cloudinaryPublicId, cloudinaryUrl, filename, duration
      Response: id, videoUrl, thumbnailUrl (using Cloudinary transformation), createdAt
    acceptance_criteria:
      - POST /api/recordings endpoint created
      - Requires authentication
      - Validates Cloudinary public ID format
      - Stores recording in database with user association
      - Generates thumbnail URL using Cloudinary transformations
    depends_on: [3]
    effort: 2
    status: completed

  - id: 6
    github_issue: 158
    milestone: 2
    title: Implement CloudinaryUploader in recorder package
    description: |
      Create a new uploader implementation that uploads directly to Cloudinary.

      Replace DevUploader with CloudinaryUploader that:
      1. Requests a signed upload from the API
      2. Chunks the video file (6MB chunks for Cloudinary)
      3. Uploads chunks directly to Cloudinary with proper headers
      4. Registers the completed upload with the API

      Cloudinary chunked upload requirements:
      - X-Unique-Upload-Id header (same for all chunks)
      - Content-Range header: bytes start-end/total
      - Each chunk must be >5MB (except last)
    acceptance_criteria:
      - CloudinaryUploader implements Uploader interface
      - Requests signature from API before upload
      - Chunks files into 6MB segments
      - Uploads directly to Cloudinary with required headers
      - Registers completed upload with API
    depends_on: [4, 5]
    effort: 3
    status: completed

  - id: 7
    github_issue: 159
    milestone: 2
    title: Update recording routes for Cloudinary URLs
    description: |
      Update recording routes to work with Cloudinary URLs.

      - video.ts: Redirect (302) to Cloudinary URL instead of streaming
      - thumbnail.ts: Redirect (302) to Cloudinary thumbnail URL (with transformation)
      - get.ts: Return video_url and thumbnail_url in response
      - delete.ts: Call Cloudinary API to delete by public_id

      Thumbnail URL via Cloudinary transformations:
      https://res.cloudinary.com/{cloud}/video/upload/c_thumb,w_320,h_180/{public_id}.jpg
    acceptance_criteria:
      - GET /recordings/:id/video redirects to Cloudinary URL
      - GET /recordings/:id/thumbnail redirects to Cloudinary transformation URL
      - GET /recordings/:id includes video_url and thumbnail_url
      - DELETE removes file from Cloudinary via API
    depends_on: [3]
    effort: 2
    status: completed

  - id: 8
    github_issue: 160
    milestone: 2
    title: Remove legacy upload routes and devOnly middleware
    description: |
      Remove the old chunked upload routes that uploaded to the server.

      Files to remove:
      - packages/api/src/routes/upload/ (entire directory)
      - DevUploader from recorder package
      - devOnly middleware function

      Files to update:
      - packages/api/src/app.ts - remove upload route mounting
    acceptance_criteria:
      - Old /api/dev/upload/* routes removed
      - devOnly middleware removed
      - Upload route directory deleted
      - App.ts cleaned up
    depends_on: [6]
    effort: 1
    status: completed

  # Milestone 3: Frontend Serving & Heroku Deployment
  - id: 9
    github_issue: 151
    milestone: 3
    title: Configure API to serve frontend bundle
    description: |
      Configure Express to serve the built frontend as static files in production.

      - Add express.static for web build directory
      - Add SPA fallback (non-API routes serve index.html)
      - Ensure API routes mounted before fallback
      - Update build scripts to build both packages
    acceptance_criteria:
      - In production, API serves frontend static files
      - SPA routing works (non-API paths serve index.html)
      - API routes still work correctly
      - Development mode unchanged
    depends_on: []
    effort: 2
    status: completed

  - id: 10
    github_issue: 152
    milestone: 3
    title: Create Heroku configuration files
    description: |
      Create configuration files for Heroku deployment.

      Files to create:
      - Procfile (web dyno command)
      - app.json (addons, buildpacks, env)
      - .nvmrc (Node version)

      Update package.json:
      - engines.node
      - heroku-postbuild script for migrations
    acceptance_criteria:
      - Procfile defines web dyno command
      - app.json defines PostgreSQL addon
      - Node version specified
      - Build scripts work for Heroku deployment
    depends_on: [9]
    effort: 2
    status: completed

  - id: 11
    github_issue: 153
    milestone: 3
    title: Document Heroku deployment process
    description: |
      Create documentation for the Heroku deployment process.

      Create docs/DEPLOYMENT.md covering:
      - Initial Heroku setup (create app, add addons)
      - Environment variables (which are required, which are auto-set)
      - Database migrations
      - Deployment workflow
      - Cloudinary configuration notes
      - Troubleshooting
    acceptance_criteria:
      - DEPLOYMENT.md covers initial Heroku setup steps
      - All environment variables documented
      - Database migration process documented
      - Deployment workflow documented
    depends_on: [10]
    effort: 1
    status: completed
